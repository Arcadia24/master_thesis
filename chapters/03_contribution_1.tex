\section{Plant as sensor}

\subsection{The electronic interface}

The electronic interface is the interface that allows a compute unit to capture and interpret the plant signal and
communication. The interface is a device made by us for this use case. The printed circuit board (PCB)
device is composed of 3 main parts:
\begin{itemize}
    \item The core of the circuit, the microcontroller, an ESP32 Wroom 32
    \item An electronic filter connected using an electrode to the plant
    \item A sound part of the PCB that is including an audio amplifier, a volume knob and a terminal block to connect a speaker
\end{itemize}

The design of the PCB has been done using the open source software Kicad.
As said previously, the circuit contains 3 parts.

The core of the circuit is the computation part, including the microcontroller, an ESP32. All the other
devices of the circuit are connected to the ESP32. The choice to use a devkit has been done 
to ease the electronic conception and to avoid any communication and soldering issue with the MCU\footnote[1]{Microcontroller Unit}.

\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth]{images/iop.pdf}
    \caption{The main schematic of the device. This main schematic regroups components and sub-sheets (including the audio circuit
    and the filter circuit). The main component is an ESP32 Wroom DevKit. All other components are linked to this
    microcontroller} 
    \vspace{0.1cm}
    \label{fig:iop_schematic_main}
\end{figure}

%TODO: Talk about the humidity sensor

The circuit component that allows us to read data from the plant is the electronic filter.
This filter has been designed by \textit{Jakub Nikonowicz} and \textit{Łukasz Matuszewski} 
from \textit{Politechnika Poznańska}.
Thanks to them, I adapted it for my application on my embedded device. 

\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth]{images/iop-plant_filter.pdf}
    \caption{The electronic circuit designed to capture the interaction by analyzing the electronic
    frequency response. The circuit includes 3 resistors, 3 inductors and 3 capacitors as main components} 
    \vspace{0.1cm}
    \label{fig:iop_schematic_filter}
\end{figure}

This filter is ending by a crocodile clamp that is directly connected to the plant.

The last part of the circuit is the sound output/rendering. This circuit includes a small amplifier,
the LM386 from Texas Instruments. The rest of the circuit are components needed in order to 
induce amplification on the signal without creating to many noise and saturation.

\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth]{images/iop-audio_circuit.pdf}
    \caption{The sound output part of the circuit that is used to render the sound. 
    This part includes a small amplifier, the LM386. The circuit also includes the components necessary
    to control and handle the amplification (reduce noise and saturation)} 
    \vspace{0.1cm}
    \label{fig:iop_schematic_audio}
\end{figure}

The PCB is built to be able to add a micro-SD slot (ref to \ref{fig:iop_schematic_main}). This micro-SD slot
allows to increase the storage of the embedded ROM. This can be used to store pre-built sounds and music 
to avoid generating a sound on-board.  


Once the schematic is done, we have to route the tracks. It exists multiple way to route PCB 
(single-sided, double-sided, multiple layers). We choose double sided, 2 layers on each side of the PCB.

\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth]{images/iop-routed_pcb.pdf}
    \caption{The routed double sided PCB.} 
    \vspace{0.1cm}
    \label{fig:iop_routed_pcb}
\end{figure}

Kicad also allows us to generated a 3D view of the future PCB. This allows us to imagine what the
PCB will look like when it will be manufactured.
\begin{figure}[h!]
    \centering
    \includegraphics[width=0.8\textwidth]{images/front_iop_3D_view_modified.png}
    \caption{Front 3D rendering of the built PCB. The rendering is done using open source software: Kicad} 
    \vspace{0.1cm}
    \label{fig:front_iop_3D_view_modified}
\end{figure}

\subsection{Human interaction}

\subsubsection{Use of the sensor/filter}

The device is able to capture the human interaction with the plant. The touch interaction is inducing changes
in the impedance, capacitance and inductance of the plant. Values are captured using the GPIO (General Port Input/Output)
14 of the ESP32 DevKit. This GPIO is able to read analog data and convert them to digital values using analog to digital
converter (ADC). The values are a floating point number between %TODO: Add the range of the values here.
Values are fluctuating depending on the interaction. 

%TODO: Add a table comparing the values depending on the interaction

The possibilities of 


\subsubsection{Sonification on the device} % FIXME: subsubsection ??

The human interaction goes through the sonification on the device. ESP32 embeds a 8-bit digital to analog converter (DAC).
The embed DAC is enough to play low quality sounds. Combined with the micro-SD card including in it, it is a media player.
Using the \textit{Arduino Audio Tools} library it is possible to read MP3, Wav and other audio format.
Taking the sensor value as an input, you can then apply a pitch shift on the data that will be rendered on the DAC.
The pitch shift is a value included between 0 and 100. We are mapping the max value of the sensor and the min value
to this range using the \textit{map()} Arduino function.

The data is sent to the DAC and rendered. \textit{Arduino Audio Tools} also includes a way to communicate data to the
DAC.

%TODO: Add oscilloscope screenshot of the sound output.

There are two DAC available on the ESP32. DAC 1 and DAC 2 respectively on GPIO25 and GPIO26. The IoP device allows
to choose between the one you want by using a removable jumper.

The output of the DAC is too low to be able to render it on a speaker. The amplification circuit allows a small 
amplification of the output. The amplifier is a basic and simple one. I added a 10k Ohms potentiometer to be able to
tweak the volume. The sound quickly reach amplifier limitations and is becoming saturated. 

The amplified output is sent to a terminal block that acts as the connection interface to the audio speaker.
The audio speaker chosen in our specific example is a 8 Ohms 3 Watts speaker. 

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.8\textwidth]{images/speaker.jpg}
    \caption{8 ohms 3 Watts basic speaker used in our example.} 
    \vspace{0.1cm}
    \label{fig:speaker}
\end{figure}


\newpage
\subsubsection{User study}
\input{chapters/user_study}
\subsection{Final product and future work}

The final product is an embedded device that include signal filtering, wireless communication and embedded sonification.


To improve the device, the PCB could be reduced in size using a surface mounted device (SMD) ESP32 instead of a DevKit.
I already started to work on a new version of the device. This version is only designed on Kicad and not prototyped.
The rest of circuit is similar. 

%TODO: Add a schematic of the new PCB


A better audio amplifier could be explored in order to reduce the distortion of the sound.
Adding an external digital to analog converter is also a possibility in order to upgrade the output. However,
this possibility adds new components that will increase the size. Exploring the I2S protocol opens better output.
The I2S protocol is a protocol  %TODO: Talk quickly about I2S protocol


\subsection{Conclusion}